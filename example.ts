/**
 * Ejemplo bÃ¡sico de uso de la librerÃ­a Deno Oracle
 *
 * Para probar este ejemplo:
 * 1. Ajusta la configuraciÃ³n de conexiÃ³n segÃºn tu entorno
 * 2. Ejecuta: deno run --allow-net --allow-read --allow-env example.ts
 */

import { closePool, GenericController, initializePool, MemoryCache, querySQL, SqlBuilder } from "./mod.ts";

// ConfiguraciÃ³n de conexiÃ³n (ajustar segÃºn tu entorno)
const dbConfig = {
  user: "tu_usuario",
  password: "tu_password",
  connectString: "localhost:1521/XE",
  poolMin: 2,
  poolMax: 5,
};

// ConfiguraciÃ³n de entidad de ejemplo
const userEntityConfig = {
  tableName: "usuarios",
  primaryKey: "id",
  displayName: "Usuarios",
  description: "GestiÃ³n de usuarios del sistema",
  fields: {
    id: { type: "number", required: true },
    nombre: { type: "string", required: true, maxLength: 100 },
    email: { type: "string", required: true, maxLength: 255 },
    activo: { type: "boolean", defaultValue: true },
    fecha_creacion: { type: "date" },
  },
  operations: {
    create: true,
    read: true,
    update: true,
    delete: true,
    search: true,
    paginate: true,
  },
};

async function ejemploBasico() {
  try {
    console.log("ğŸš€ Iniciando ejemplo de Deno Oracle Library");

    // 1. Inicializar conexiÃ³n
    console.log("ğŸ“¡ Inicializando pool de conexiones...");

    // Nota: En un proyecto real, importarÃ­as el mÃ³dulo oracledb
    // Por ahora, creamos un mock para el ejemplo
    const mockOracledb = {
      OUT_FORMAT_OBJECT: 4001,
      getConnection: () =>
        Promise.resolve({
          execute: () => Promise.resolve({ rows: [{ mensaje: "ConexiÃ³n exitosa!" }] }),
          close: () => Promise.resolve(),
        }),
    };

    await initializePool(mockOracledb, dbConfig);

    // 2. Probar consulta directa
    console.log("ğŸ” Ejecutando consulta directa...");
    const testResult = await querySQL("SELECT 'ConexiÃ³n exitosa!' as mensaje FROM dual");
    console.log("âœ… Resultado:", testResult.rows?.[0]);

    // 3. Crear cache
    console.log("ğŸ’¾ Configurando cache...");
    const cache = new MemoryCache({
      defaultTTL: 300,
      maxSize: 1000,
      cleanupInterval: 60000,
    });

    // 4. Crear SQL Builder
    console.log("ğŸ—ï¸ Creando SQL Builder...");
    const sqlBuilder = new SqlBuilder(userEntityConfig);

    // Generar consultas SQL dinÃ¡micamente
    const selectQuery = sqlBuilder.buildSelectQuery({
      filters: { activo: true },
      orderBy: "nombre",
      orderDirection: "ASC",
    });
    console.log("ğŸ“ SQL generado:", selectQuery.sql);
    console.log("ğŸ”— ParÃ¡metros:", selectQuery.params);

    const insertQuery = sqlBuilder.buildInsertQuery({
      nombre: "Usuario Ejemplo",
      email: "ejemplo@test.com",
      activo: true,
    });
    console.log("ğŸ“ INSERT SQL:", insertQuery.sql);

    // 5. Crear controlador CRUD
    console.log("ğŸ® Creando controlador CRUD...");
    const userController = new GenericController(userEntityConfig, cache);

    // Si la tabla existe, hacer operaciones CRUD
    try {
      console.log("ğŸ“Š Obteniendo estadÃ­sticas...");
      const stats = await userController.getStats();
      console.log("ğŸ“ˆ EstadÃ­sticas:", stats);

      console.log("ğŸ” Buscando usuarios...");
      const usuarios = await userController.findAll({
        page: 1,
        pageSize: 5,
        orderBy: "id",
      });
      console.log("ğŸ‘¥ Usuarios encontrados:", usuarios.data.length);
      console.log("ğŸ“„ PaginaciÃ³n:", usuarios.pagination);
    } catch (_error) {
      console.log("âš ï¸ La tabla 'usuarios' no existe. Eso estÃ¡ bien para este ejemplo.");
      console.log("ğŸ’¡ Para usar el CRUD completo, crea primero la tabla:");
      console.log(`
CREATE TABLE usuarios (
  id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre VARCHAR2(100) NOT NULL,
  email VARCHAR2(255) NOT NULL UNIQUE,
  activo NUMBER(1) DEFAULT 1,
  fecha_creacion DATE DEFAULT SYSDATE
);
      `);
    }

    // 6. Demostrar cache
    console.log("ğŸ’¾ Demostrando cache...");
    cache.set("usuario:test", { id: 1, nombre: "Test User" });
    const cachedUser = cache.get("usuario:test");
    console.log("ğŸ¯ Usuario desde cache:", cachedUser);

    // EstadÃ­sticas del cache
    const cacheStats = cache.getStats();
    console.log("ğŸ“Š EstadÃ­sticas del cache:", cacheStats);

    console.log("âœ… Ejemplo completado exitosamente!");
  } catch (error) {
    console.error("âŒ Error en el ejemplo:", error.message);
    console.log("ğŸ’¡ AsegÃºrate de:");
    console.log("   - Tener Oracle Database ejecutÃ¡ndose");
    console.log("   - Configurar correctamente las credenciales");
    console.log("   - Tener acceso de red al servidor Oracle");
  } finally {
    // 7. Cerrar conexiones
    console.log("ğŸ”Œ Cerrando pool de conexiones...");
    await closePool();
    console.log("ğŸ‘‹ Â¡Hasta luego!");
  }
}

// Ejecutar ejemplo si es el mÃ³dulo principal
// Nota: import.meta.main no estÃ¡ disponible en TypeScript estricto
// En su lugar, verificamos si es ejecutado directamente

// TambiÃ©n exportar para uso como mÃ³dulo
export { ejemploBasico };
